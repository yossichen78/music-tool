<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">	
</head>
<body onkeydown="keyPress(event)" onkeyup="keyUp(event)">
	<button onclick='init()'>TURN ON</button>
	<button onclick='turnOff()'>TURN OFF</button>
	<button onclick='savePreset()'>Save Preset</button>
	Preset: <select onchange='loadPreset(this)'>
		<option>preset1</option>
		<option>preset2</option>
		<option>preset3</option>
		<option>preset4</option>
		<option>preset5</option>
	</select>

	Synth Mode: <input type='radio' name='synthmode' onclick="modeClick(this);" value="0" checked="checked"> Mono </input> <input name='synthmode' type='radio' onclick="modeClick(this);" value="1"> Poly </input>
	<div>
		Yossynth
		Instructions: Turn on to start sound engine. Keys 1 - 4 control drum samples, keyz (z - ,) and (q - i) control synthesizer. Refresh to reset! Try the different presets! More features coming soon
	</div>
	<div id='oscSection'>
	</div>
	<div id='filterSection'>
	</div>
	<div id='ampSection'>
	</div>
	<div id='delaySection'>
	</div>

	<div>
		Keyboard:
		<button onclick='playPitch(131)'>C</button>
		<button onclick='playPitch(147)'>D</button>
		<button onclick='playPitch(165)'>E</button>
		<button onclick='playPitch(175)'>F</button>
		<button onclick='playPitch(196)'>G</button>
		<button onclick='playPitch(220)'>A</button>
		<button onclick='playPitch(247)'>B</button>
		<button onclick='playPitch(261)'>C</button>
	</div>
	<div>
		<canvas id="canvas" width="300" height="300">
			Oscillator Graph
		</canvas>
	</div>
	<div>

		SEQ 
		<button onclick='startSeq()'>Start</button>
		<button onclick='stopSeq()'>Stop</button>
		BPM:
		<input type='number' oninput="changeParam(event,'bpm')" value='110' />
		
	</div>
	<div id='synthSeq'></div>

	<div> <button>change</button> Sample 4: <span id='sampleSeq3'></span>	</div>
	<div> <button>change</button> Sample 3: <span id='sampleSeq2'></span>	</div>
	<div> <button>change</button> Sample 2: <span id='sampleSeq1'></span> </div>
	<div> <button>change</button> Sample 1: <span id='sampleSeq0'></span> </div>


<script type="text/javascript">
var midi =[];
var a = 440; // a is 440 hz...
for (var x = 0; x < 127; x++)
{
	midi[x] = (440 / 32) * (Math.pow(2, ((x - 9) / 12)));
}
navigator.requestMIDIAccess()
	.then(onMIDISuccess, onMIDIFailure);

function onMIDISuccess(midiAccess) {
	console.log('onMIDISuccess')
	for (var input of midiAccess.inputs.values()){
		input.onmidimessage = getMIDIMessage;
	}
}

function getMIDIMessage(midiMessage) {
	// console.log(midiMessage)
	if (midiMessage.data[0] == 144 && midiMessage.data[2] > 0){
		console.log(midiMessage.data[1])
		startPitch(midi[midiMessage.data[1]])
	}
	if (midiMessage.data[0] == 144 && midiMessage.data[2] == 0){
		stopPitch(midi[midiMessage.data[1]])
	}
}

function onMIDIFailure() {
	console.log('Could not access your MIDI devices.');
}

function buildOscSection(i){
	elem = document.getElementById('oscSection');
	if (i == 0){
		while (elem.firstChild) {
			elem.removeChild(elem.firstChild);
		}
	}

	elemString = "Osc "+(i+1)+": Gain: <input id='gain_"+i+"' min='0' step='0.01' max='1' type='range' oninput='changeParams(event,\"gainVals\" "+i+")' value='"+gainVals[i]+"'/>	Shape: <input id='sine_"+i+"' type='radio' value='sine' name='waveform"+i+"' onclick='changeWaveform(this,"+i+")'>sine</input> <input id='square_"+i+"' type='radio' value='square' name='waveform"+i+"' onclick='changeWaveform(this,"+i+")'>square</input> <input id='sawtooth_"+i+"' type='radio' value='sawtooth' name='waveform"+i+"' onclick='changeWaveform(this,"+i+")'>sawtooth</input> Detune: <input min='-5' step='.01' max='5' type='range' oninput='changeDetune(event,"+i+")' value='"+detuneVals[i]+"'/> Octave: <input min='-3' step='1' max='3' type='range' oninput='changeParam(event,\"octaveVals\","+i+")' value='"+octaveVals[i]+"'/> <br>"	
	elem.insertAdjacentHTML('beforeend', elemString)
	shapeElem = document.getElementById(typeVals[i]+'_'+i);
	shapeElem.checked = true;
}

var buildFilterSection = ()=>{
	elem = document.getElementById('filterSection');
	while (elem.firstChild) {
			elem.removeChild(elem.firstChild);
	}
	elemString = "Filter Cutoff: <input min='0.0001' step='0.01' max='2000' type='range' oninput='changeParam(event,\"cutoffVal\")' value='"+cutoffVal+"'/> Resonance: <input min='0' step='0.01' max='40' type='range' oninput='changeParam(event,\"resonanceVal\")' value='"+resonanceVal+"' /> <br> Filter Attack: <input min='0' step='0.01' max='2' type='range' oninput='changeParam(event,\"filterParams\",0)' value='"+filterParams[0]+"'/> Sustain: <input min='0' step='0.01' max='2' type='range' oninput='changeParam(event,\"filterParams\",1)' value='"+filterParams[1]+"'/> Release: <input min='0' step='0.01' max='2' type='range' oninput='changeParam(event,\"filterParams\",2)' value='"+filterParams[2]+"'/>";
		elem.insertAdjacentHTML('beforeend', elemString)
}

var buildAmpSection = ()=>{
	elem = document.getElementById('ampSection');
	while (elem.firstChild) {
			elem.removeChild(elem.firstChild);
	}
	elemString = "AMP Attack: <input min='0' step='0.01' max='2' type='range' oninput='changeParam(event, \"ampParams\",0)' value='"+ampParams[0]+"'/> Sustain: <input min='0' step='0.01' max='2' type='range' oninput='changeParam(event, \"ampParams\",1)' value='"+ampParams[1]+"'/> Release: <input min='0' step='0.01' max='2' type='range' oninput='changeParam(event, \"ampParams\",2)' value='"+ampParams[2]+"'/>";
		elem.insertAdjacentHTML('beforeend', elemString)
}

var buildDelaySection = ()=>{
	elem = document.getElementById('delaySection');
	while (elem.firstChild) {
			elem.removeChild(elem.firstChild);
	}
	console.log(delayTime)
	console.log(delayFeedback)
	elemString = "Delay Time: <input min='0' step='0.01' max='1' type='range' oninput='changeDelayTime(event)' value='"+(delayTime || 0)+"' /> Feedback: <input min='0' step='0.01' max='1' type='range' oninput='changeDelayFeedback(event)' value='"+(delayFeedback || 0)+"'/>";
		elem.insertAdjacentHTML('beforeend', elemString)
}

function buildSynthSeq(i){
	elem = document.getElementById('synthSeq');
	if (i == 0){
		while (elem.firstChild) {
				elem.removeChild(elem.firstChild);
		}
	}
	elemString = "<input style='width:50px' type='number' oninput='changeParam(event,\"sequence\","+i+")'' value='"+sequence[i]+"' />"
	elem.insertAdjacentHTML('beforeend', elemString)
}

function buildSampleSeq(i){
	for (let j = 3; j >= 0; j--){
		elem = document.getElementById('sampleSeq'+j)
		if (i == 0){
			while (elem.firstChild) {
					elem.removeChild(elem.firstChild);
			}
		}
		if (sampleSequence[j][i])
			elem.insertAdjacentHTML('beforeend',"<input type='checkbox' oninput='changeSampleSeq(event,"+j+","+i+")' checked='true'/>")
		else
			elem.insertAdjacentHTML('beforeend',"<input type='checkbox' oninput='changeSampleSeq(event,"+j+","+i+")' />")
	}
}

function keyUp(e){
	console.log('keyUp', e.keyCode)	
	if (keyboardPitchMap[e.keyCode]){
		console.log(keyboardPitchMap[e.keyCode])
		stopPitch(keyboardPitchMap[e.keyCode])
	}
}

function keyPress(e){
	if (keyboardPitchMap[e.keyCode]){
		startPitch(keyboardPitchMap[e.keyCode])
	}
	else if (samples[e.keyCode-49])
		playSound(samples[e.keyCode-49])
	else if (e.keyCode == 32){
		if (!initiated)
			init()
		else{
			if (playing)
				stopSeq()
			else
				startSeq()
		}
	}
}
var keyboardPitchMap = {
	90:131,
	88: 147,
	67: 165,
	86: 175,
	66: 196,
	78: 220,
	77: 247,
	188: 261,
	81: 261,
	87: 294,
	69: 330,
	82: 350,
	84: 392,
	89: 440,
	85: 494,
	73: 522
}

var keyboardMidiMap = {
	90:48,
	88: 50,
	67: 52,
	86: 53,
	66: 55,
	78: 57,
	77: 59,
	188: 60,
	81: 60,
	87: 62,
	69: 64,
	82: 65,
	84: 67,
	89: 69,
	85: 71,
	73: 72
}

function changeSampleSeq(e,i,j){
	sampleSequence[i][j] = e.target.checked;
}


var gain, 
	seqPlay,
	delay,
	feedback,
	masterGain,
	currentVoice,
	oscNum = 4,
	osc, 
	biquadFilter,
	voiceGain,
	merger,
	context,  
	samples,
	initiated = false,
	seqPosition,
	playing,
	availableVoices, 
	usedVoices, 
	voicesNotes;

var preset1 = {"voiceNum":1,"bpm":125,"ampParams":[0,0.89,0.45],"filterParams":[0,0.31,0.15],"typeVals":["square","square","sawtooth","sine"],"gainVals":["0.41","0.55","0.74","0.55"],"detuneVals":[0.28,0.27,0.25,0.6],"frequencyVals":[220,220,220,220],"resonanceVal":16.78,"cutoffVal":1220.3901,"octaveVals":[-1,0,1,0],"sequence":[220,0,110,0,110,0,110,0,196,272,220,0,261,220,165,0],"urls":["https://raw.githubusercontent.com/yossichen78/music-tool/master/Kick16.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Snare10.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Closedhat01.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Rimshot01.wav"],"sampleSequence":[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,false,true,0,0,0,0,0,0,0,true,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[true,true,1,true,true,true,1,true,true,true,1,true,true,true,1,true,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[false,0,false,0,0,false,false,0,false,false,0,false,false,false,0,false,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0]],"delayTime":0,"delayFeedback":0}
var preset2 = {"voiceNum":1,"bpm":110,"ampParams":[0,1,1.16],"filterParams":[0.1,0.59,1.1],"typeVals":["sine","sawtooth","sawtooth","sine"],"gainVals":[0.5,0.5,0.5,0.5],"detuneVals":[0.04,0.3,-0.2,-0.3],"frequencyVals":[196,196,196,196],"resonanceVal":16.45,"cutoffVal":1417.4901,"octaveVals":[-1,0,1,0],"sequence":[220,0,0,0,0,0,0,0,196,0,220,0,261,0,165,0,0,0,0,0,0,0,0,0,147,0,165,0,196,0,131,0,0,0,0,0,0,0,0,0,123,0,131,0,165,0,110,0,0,0,0,0,0,0,0,0,123,0,0,0,131,0,0,0],"urls":["https://raw.githubusercontent.com/yossichen78/music-tool/master/Kick16.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Snare10.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Closedhat01.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Rimshot01.wav"],"sampleSequence":[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0]]}
var preset3 = {"voiceNum":4,"bpm":66,"ampParams":[1,0.69,0.66],"filterParams":[0.77,0.43,0.52],"typeVals":["sine","sawtooth","sine","sine"],"gainVals":[0.5,0.5,0.5,0.5],"detuneVals":[0.51,-0.54,0.69,-1.65],"frequencyVals":[535,535,535,535],"resonanceVal":2.73,"cutoffVal":1228.6201,"octaveVals":[2,4,1,0.25],"sequence":[272,0,272,676,110,342,110,0,196,272,220,236,156,220,165,535],"urls":["https://raw.githubusercontent.com/yossichen78/music-tool/master/Kick16.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Snare10.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Closedhat01.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Rimshot01.wav"],"sampleSequence":[[1,true,false,true,false,0,0,0,1,0,0,0,1,true,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,false,false,true,0,0,0,true,0,0,0,false,false,true,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[false,true,1,false,true,true,false,false,false,true,false,true,true,true,1,true,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[false,0,true,false,false,true,false,false,true,false,false,false,true,true,0,false,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,1,0,0,0]]}
var preset4 = {"voiceNum":4,"bpm":110,"ampParams":[0,1,1.13],"filterParams":[0,1.08,1.08],"typeVals":["sine","sawtooth","sine","sawtooth"],"gainVals":[0.5,0.5,0.5,0.5],"detuneVals":[0.41,0.41,0.42,0.56],"frequencyVals":[196,196,196,196],"resonanceVal":9.3,"cutoffVal":1500,"octaveVals":[-1,0,1,2],"sequence":[220,0,0,196,0,0,196,0,0,0,196,0,220,0,220,261],"urls":["https://raw.githubusercontent.com/yossichen78/music-tool/master/Kick16.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Snare10.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Closedhat01.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Rimshot01.wav"],"sampleSequence":[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,true,0,0,0,true,0,0,0,true,0,0,0,true,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}
var preset5 = {"delayFeedback":0.26,"delayTime":0.38,"voiceNum":1,"bpm":120,"ampParams":[0,0.1,0.03],"filterParams":[0,1.12,0],"typeVals":["square","square","square","square"],"gainVals":[0.5,0.5,0.5,0.5],"detuneVals":[0.03,0.23,1.29,-0.16],"frequencyVals":[330,330,330,330],"resonanceVal":3.25,"cutoffVal":1546.0501,"octaveVals":[0,0,1,0],"sequence":[294,null,330,null,350,null,440,null,522,null,440,null,522,null,440,null],"urls":["https://raw.githubusercontent.com/yossichen78/music-tool/master/Kick16.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Snare10.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Closedhat01.wav","https://raw.githubusercontent.com/yossichen78/music-tool/master/Rimshot01.wav"],"sampleSequence":[[1,0,false,0,false,0,true,0,false,0,true,0,false,0,true,0],[0,0,0,0,true,0,0,0,false,false,0,0,true,false,false,0],[true,0,true,0,true,0,true,false,true,0,true,0,true,0,true,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}
preset = preset1;

var bpm,
	delayTime,
	delayFeedback,
	voiceNum,  
	ampParams,  
	filterParams,  
	typeVals,
	gainVals,
	detuneVals,
	frequencyVals,
	resonanceVal,
	cutoffVal,
	octaveVals,
	sequence,
	urls,
	sampleSequence;
function setPreset(){
	bpm = preset.bpm;
	delayTime = preset.delayTime;  
	delayFeedback = preset.delayFeedback;  
	voiceNum = preset.voiceNum;  
	ampParams = preset.ampParams;  
	filterParams = preset.filterParams;  
	typeVals = preset.typeVals;
	gainVals = preset.gainVals;
	detuneVals = preset.detuneVals;
	frequencyVals = preset.frequencyVals;
	resonanceVal = preset.resonanceVal;
	cutoffVal = preset.cutoffVal;
	octaveVals = preset.octaveVals;
	sequence = preset.sequence;
	urls = preset.urls;
	sampleSequence = preset.sampleSequence;
}
setPreset()

function savePreset(){
	preset.bpm = bpm;
	preset.delayTime = delayTime;  	
	preset.delayFeedback = delayFeedback;  	
	preset.voiceNum = voiceNum;  	
	preset.ampParams = ampParams;
	preset.filterParams = filterParams;
	preset.typeVals = typeVals;
	preset.gainVals = gainVals;
	preset.detuneVals = detuneVals;
	preset.frequencyVals = frequencyVals;
	preset.resonanceVal = resonanceVal;
	preset.cutoffVal = cutoffVal;
	preset.octaveVals = octaveVals;
	preset.sequence = sequence;
	preset.urls = urls;
	preset.sampleSequence = sampleSequence;

	console.log(JSON.stringify(preset));
}	
function loadPreset(myRadio) {
	for (var i = 0; i < voiceNum; i++){
		stopVoice(i)
	}
	stopSeq()	
		preset = window[myRadio.value]
	setPreset()
		init()
}

function modeClick(myRadio) {
	for (var i = 0; i < voiceNum; i++){
		stopVoice(i)
	}
	stopSeq()
		if (myRadio.value == 1)
			voiceNum = 4;
		else
			voiceNum = 1;
		init()
 
}

function changeDelayTime(e){
	delayTime = parseFloat(e.target.value)
	delay.delayTime.value = delayTime;
}

function changeDelayFeedback(e){
	delayFeedback = parseFloat(e.target.value)
	feedback.gain.value = delayFeedback;
}

function changeParam(e, val, i){
	value = parseFloat(e.target.value)
	if (i || i === 0)
		window[val][i] = value;
	else
		window[val] = value;
}

function setOscVal(i){
	var value = frequencyVals[i] * Math.pow(2, octaveVals[i]) + detuneVals[i];
	osc[i+currentVoice*oscNum].frequency.value = value;
	gain[i+currentVoice*oscNum].gain.value = gainVals[i];
}

var playPitch = (pitch) => {
	startPitch(pitch);
	setTimeout(stopPitch,100,pitch)
}

var getNextVoice = ()=>{

	a = availableVoices.pop()
	if (a >= 0)
		return a
	else
		return usedVoices.shift()
}
var startPitch = (pitch) => {
	stopPitch(pitch)
	currentVoice = getNextVoice()
	setPitch(pitch);
	voicesNotes[currentVoice] = pitch;
	bang(currentVoice);
	usedVoices.push(currentVoice);
}


var stopPitch = (pitch) =>{
	for (var i = 0; i < voiceNum; i++){
		if (voicesNotes[i] == pitch){
			stopVoice(i);
			voicesNotes[i] = null;
			usedVoices.splice(usedVoices.indexOf(i), 1);
			availableVoices.push(i);

		}
	}
}

var setPitch = (pitch) => {
	for (var i = 0; i < oscNum; i++){
		frequencyVals[i] = pitch;
		setOscVal(i);
	}	
}

var bang = (v) => {
	biquadFilter[v].Q.value = resonanceVal;
	biquadFilter[v].frequency.cancelScheduledValues(context.currentTime)
	voiceGain[v].gain.cancelScheduledValues(context.currentTime)
	voiceGain[v].gain.setValueAtTime(voiceGain[v].gain.value, context.currentTime);
	//A
	var AmpAttackEnd = context.currentTime + 0.001 + Math.floor(ampParams[0] * 1000)/1000; 
	voiceGain[v].gain.linearRampToValueAtTime(1.0, AmpAttackEnd);

	// //S
	// var AmpSustainEnd = AmpAttackEnd + 0.001 + Math.floor(ampParams[1] * 1000)/1000; 
	// voiceGain[v].gain.linearRampToValueAtTime(1.0, AmpSustainEnd);

	// //R
	// var AmpReleaseEnd = AmpSustainEnd + 0.001 + Math.floor(ampParams[2] * 1000)/1000; 
	// voiceGain[v].gain.linearRampToValueAtTime(0, AmpReleaseEnd);

	biquadFilter[v].frequency.setValueAtTime(20, context.currentTime + 0.001);
	//A 
	var FilterAttackEnd = context.currentTime + 0.001 + Math.floor(filterParams[0] * 1000)/1000; 
	biquadFilter[v].frequency.linearRampToValueAtTime(cutoffVal, FilterAttackEnd)

	// //S
	// var FilterSustainEnd = FilterAttackEnd + 0.001 + Math.floor(filterParams[1] * 1000)/1000; 
	// biquadFilter[v].frequency.linearRampToValueAtTime(cutoffVal, FilterSustainEnd)

	// //R
	// var FilterReleaseEnd = FilterSustainEnd + 0.001 + Math.floor(filterParams[2] * 1000)/1000; 
	// biquadFilter[v].frequency.linearRampToValueAtTime(20, FilterReleaseEnd)

}
var stopVoice = (v)=>{
	targetFreq = biquadFilter[v].frequency.value
	targetGain = voiceGain[v].gain.value

	biquadFilter[v].frequency.cancelScheduledValues(context.currentTime)
	voiceGain[v].gain.cancelScheduledValues(context.currentTime)
	
	voiceGain[v].gain.setValueAtTime(targetGain, context.currentTime);
	biquadFilter[v].frequency.setValueAtTime(targetFreq, context.currentTime);

	//R
	var AmpReleaseEnd = context.currentTime + 0.001 + Math.floor(ampParams[2] * 1000)/1000; 
	voiceGain[v].gain.linearRampToValueAtTime(0, AmpReleaseEnd);

	// //R
	var FilterReleaseEnd = context.currentTime + 0.001 + Math.floor(filterParams[2] * 1000)/1000; 
	biquadFilter[v].frequency.linearRampToValueAtTime(20, FilterReleaseEnd)

}


function init(){
	if (!initiated) {
		initiated = true;
		gain = [];
		osc = [];
		biquadFilter = [];
		voiceGain = [];
		merger = [];
		samples = [];
		seqPosition = 0;
		playing = false;
		availableVoices = []; 
		usedVoices = [];
		voicesNotes = [];	
		context = new AudioContext();
		
		var analyser = context.createAnalyser();
		analyser.fftSize = 2048;
		var analyser = context.createAnalyser();
		var bufferLength = analyser.frequencyBinCount;
		var dataArray = new Uint8Array(bufferLength);

		var canvas = document.getElementById('canvas');
		var canvasCtx = canvas.getContext('2d');

		WIDTH = 400;
		HEIGHT = 150;
		canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

		function draw() {
			var drawVisual = requestAnimationFrame(draw);
			analyser.getByteTimeDomainData(dataArray);
			canvasCtx.fillStyle = 'rgb(200, 200, 200)';
			canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
			canvasCtx.lineWidth = 2;
			canvasCtx.strokeStyle = 'rgb(0, 0, 0)';
			canvasCtx.beginPath();
			var sliceWidth = WIDTH * 1.0 / bufferLength;
			var x = 0;
			for(var i = 0; i < bufferLength; i++) {
	 
						var v = dataArray[i] / 128.0;
						var y = v * HEIGHT/2;

						if(i === 0) {
							canvasCtx.moveTo(x, y);
						} else {
							canvasCtx.lineTo(x, y);
						}

						x += sliceWidth;
				}
				canvasCtx.lineTo(canvas.width, canvas.height/2);
				canvasCtx.stroke();
			};

			draw();
	 
			currentVoice = 0;
			for (let i = 0; i < oscNum; i++){
			buildOscSection(i)
		}				
		for (let i = 0; i < sequence.length; i++){
			buildSynthSeq(i)
			buildSampleSeq(i)
		}
		buildFilterSection()
		buildAmpSection()
		buildDelaySection()

		for (var v = 0; v < voiceNum; v++){
			biquadFilter[v] = context.createBiquadFilter();
			biquadFilter[v].type = 'lowpass';
			biquadFilter[v].frequency.value = cutoffVal;
			biquadFilter[v].Q.value = resonanceVal;
			voiceGain[v] = context.createGain();
			voiceGain[v].gain.value = 0;
			merger[v] = context.createChannelMerger(oscNum);

		}
		for (var i = 0; i < oscNum; i++){
			for (var v = 0; v < voiceNum; v++){
				osc[i+v*oscNum] = context.createOscillator()
				osc[i+v*oscNum].type = typeVals[i];
				gain[i+v*oscNum] = context.createGain();
				gain[i+v*oscNum].gain.value = gainVals[i];
				osc[i+v*oscNum].connect(gain[i+v*oscNum]);
				gain[i+v*oscNum].connect(merger[v],0,i);
				osc[i+v*oscNum].start();
			}
		}

		masterMerger = context.createChannelMerger(voiceNum);

		for (var v = 0; v < voiceNum; v++){
			merger[v].connect(voiceGain[v])
			voiceGain[v].connect(biquadFilter[v]);
			biquadFilter[v].connect(masterMerger,0,v);
		}

		masterGain = context.createGain();
		masterMerger.connect(masterGain)
		if (voiceNum > 1)
			masterGain.gain.value = 1
		else 
			masterGain.gain.value = .35

		delay = context.createDelay();
		delay.delayTime.value = delayTime || 0;

		feedback = context.createGain();
		feedback.gain.value = delayFeedback || 0;

		delay.connect(feedback);
		feedback.connect(delay);

		masterGain.connect(delay);
		masterGain.connect(analyser);
		delay.connect(analyser);

		analyser.connect(context.destination);	
		request = []
		for(let i = 0; i < urls.length; i++){
			request[i] = new XMLHttpRequest();
				request[i].open('GET', urls[i], true);
				request[i].responseType = 'arraybuffer';
			request[i].onload = function() {
						context.decodeAudioData(request[i].response, function(buffer) {
							samples[i] = buffer;
						});
				}
				request[i].send()
		}
	}
	availableVoices = [] 
	usedVoices = [];
	voicesNotes = [];
	for (var i = 0; i < voiceNum; i++){
		availableVoices.push(i);
	}
	
}

function playSound(buffer) {
	var source = context.createBufferSource(); // creates a sound source
	source.buffer = buffer;                    // tell the source which sound to play
	source.gain = context.createGain() 
	source.gain.gain.value = .55                   // tell the source which sound to play
	source.connect(source.gain);       
	source.gain.connect(context.destination);       
	source.start(0);                           // play the source now
																						 // note: on older systems, may have to use deprecated noteOn(time);
}

function startSeq(){
	if (!playing){
		seqPosition = 0;		
		playing = true;
		loop();
	}

}

function loop(){
		
	if (sequence[seqPosition] > 20){
		playPitch(parseFloat(sequence[seqPosition]))
	}
	for(var j = 0; j < sampleSequence.length; j++){
		if (sampleSequence[j][seqPosition]){
			playSound(samples[j]);
		}
	}	
	seqPosition++
	if (sequence.length <= seqPosition)
		seqPosition = 0
	
	seqPlay = setTimeout(loop, 15000/bpm); // check again in a second
	
}

function changeWaveform(e,i){
	typeVals[i] = e.value;
	for (var v = 0; v < voiceNum; v++){
		osc[i+v*oscNum].type = e.value;
	}
}


function changeDetune(e, i){
	detuneVals[i] = Math.floor(e.target.value * 100)/100;
}
function stopSeq(){
	clearTimeout(seqPlay);
	playing = false;
	seqPosition = 0;
	initiated = false;
}
</script>

</body>
</html>